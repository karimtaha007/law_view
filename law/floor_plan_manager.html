<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Floor Plan Viewer</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --panel-bg: #1e293b;
            --accent: #38bdf8;
            --accent-hover: #0ea5e9;
            --danger: #ef4444;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            background: var(--panel-bg);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #334155;
            z-index: 50;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .logo-area { display: flex; align-items: center; gap: 12px; }
        .logo-area h1 { font-size: 18px; font-weight: 600; letter-spacing: -0.025em; }
        .badge-viewer { 
            background: #064e3b; color: #34d399; 
            font-size: 10px; padding: 2px 8px; border-radius: 12px; 
            text-transform: uppercase; font-weight: 700;
        }

        .controls { display: flex; gap: 12px; align-items: center; }

        /* --- Buttons --- */
        .btn {
            background: #334155;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn:hover { background: #475569; }
        .btn-primary { background: var(--accent); color: #082f49; }
        .btn-primary:hover { background: var(--accent-hover); }

        /* --- Layout --- */
        main { flex: 1; display: flex; overflow: hidden; position: relative; }

        #viewport {
            flex: 1;
            background: #020617;
            position: relative;
            cursor: grab;
            overflow: hidden;
        }
        #viewport:active { cursor: grabbing; }

        #map-container {
            position: absolute;
            transform-origin: 0 0;
            will-change: transform;
        }

        #floor-image {
            display: block;
            max-width: none;
            user-select: none;
            -webkit-user-drag: none;
        }

        /* --- Points & Interaction --- */
        .point {
            position: absolute;
            background: rgba(56, 189, 248, 0.4);
            border: 2px solid var(--accent);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.2s;
            z-index: 10;
        }
        .point:hover {
            transform: translate(-50%, -50%) scale(1.4);
            background: var(--accent);
            z-index: 100;
            box-shadow: 0 0 15px var(--accent);
        }
        .point.active {
            border-color: #fbbf24;
            background: #fbbf24;
            color: #451a03;
            transform: translate(-50%, -50%) scale(1.5);
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 320px;
            background: var(--panel-bg);
            border-left: 1px solid #334155;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #334155; }
        .sidebar-header h2 { font-size: 14px; color: var(--text-dim); text-transform: uppercase; }
        
        #point-list { flex: 1; overflow-y: auto; padding: 12px; }
        .list-item {
            padding: 12px;
            border-radius: 8px;
            background: #1e293b;
            margin-bottom: 8px;
            cursor: pointer;
            border: 1px solid transparent;
            display: flex;
            justify-content: space-between;
            transition: all 0.2s;
        }
        .list-item:hover { background: #334155; }
        .list-item.active { border-color: var(--accent); background: #0f172a; }
        .list-item .meta { font-size: 12px; color: var(--text-dim); }

        /* --- Tooltip --- */
        #tooltip {
            position: fixed;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 16px;
            width: 280px;
            pointer-events: none;
            opacity: 0;
            z-index: 1000;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(8px);
        }
        #tooltip.visible { opacity: 1; }
        .tt-header { color: var(--accent); font-weight: 700; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .tt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .tt-val { background: #1e293b; padding: 6px; border-radius: 4px; font-size: 12px; }
        .tt-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; }

        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent);
            color: #082f49;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 2000;
            display: none;
        }
    </style>
</head>
<body>

<header>
    <div class="logo-area">
        <h1>Signal Analysis Pro</h1>
        <span class="badge-viewer">Viewer Mode</span>
    </div>
    <div class="controls">
        <button class="btn btn-primary" onclick="triggerFileLoad()">ðŸ“‚ Load JSON Data</button>
        <div style="width: 1px; height: 24px; background: #334155; margin: 0 8px;"></div>
        <button class="btn" onclick="zoomHandler(0.8)">âˆ’</button>
        <span id="zoom-level" style="font-size: 12px; width: 40px; text-align: center;">100%</span>
        <button class="btn" onclick="zoomHandler(1.2)">+</button>
        <button class="btn" onclick="resetView()">Reset</button>
    </div>
</header>

<main>
    <div id="viewport">
        <div id="map-container">
            <img id="floor-image" src="floor1.jpg" alt="Floor Plan Base">
        </div>
    </div>

    <aside class="sidebar">
        <div class="sidebar-header">
            <h2 id="stats-text">No Data Loaded</h2>
        </div>
        <div id="point-list">
            </div>
    </aside>
</main>

<div id="tooltip"></div>
<div id="toast" class="toast"></div>
<input type="file" id="file-input" hidden accept=".json">

<script>
    /**
     * APP STATE
     */
    const state = {
        points: [],
        scale: 1,
        offset: { x: 0, y: 0 },
        isDragging: false,
        lastMouse: { x: 0, y: 0 },
        selectedId: null
    };

    const elements = {
        viewport: document.getElementById('viewport'),
        container: document.getElementById('map-container'),
        img: document.getElementById('floor-image'),
        list: document.getElementById('point-list'),
        zoomText: document.getElementById('zoom-level'),
        tooltip: document.getElementById('tooltip'),
        fileInput: document.getElementById('file-input')
    };

    /**
     * INITIALIZATION
     */
    window.addEventListener('DOMContentLoaded', () => {
        setupInteractions();
        // Force an update once image is cached or loaded
        if (elements.img.complete) {
            resetView();
        } else {
            elements.img.onload = resetView;
        }
    });

    function setupInteractions() {
        // Panning
        elements.viewport.addEventListener('mousedown', (e) => {
            if (e.button !== 0) return;
            state.isDragging = true;
            state.lastMouse = { x: e.clientX, y: e.clientY };
        });

        window.addEventListener('mousemove', (e) => {
            if (!state.isDragging) return;
            const dx = e.clientX - state.lastMouse.x;
            const dy = e.clientY - state.lastMouse.y;
            state.offset.x += dx;
            state.offset.y += dy;
            state.lastMouse = { x: e.clientX, y: e.clientY };
            applyTransform();
        });

        window.addEventListener('mouseup', () => state.isDragging = false);

        // Zoom (Scroll)
        elements.viewport.addEventListener('wheel', (e) => {
            e.preventDefault();
            const factor = e.deltaY > 0 ? 0.9 : 1.1;
            zoomHandler(factor, e.clientX, e.clientY);
        }, { passive: false });

        // File Loading
        elements.fileInput.addEventListener('change', handleFileSelect);
    }

    /**
     * RENDERING ENGINE
     */
    function applyTransform() {
        elements.container.style.transform = `translate(${state.offset.x}px, ${state.offset.y}px) scale(${state.scale})`;
        elements.zoomText.textContent = Math.round(state.scale * 100) + '%';
        
        // Dynamic scaling for markers so they don't get huge/tiny
        document.querySelectorAll('.point').forEach(p => {
            const size = 24 / state.scale;
            p.style.width = `${size}px`;
            p.style.height = `${size}px`;
            p.style.fontSize = `${11 / state.scale}px`;
            p.style.borderWidth = `${2 / state.scale}px`;
        });
    }

    function zoomHandler(factor, centerX, centerY) {
        if (!centerX) {
            centerX = elements.viewport.clientWidth / 2;
            centerY = elements.viewport.clientHeight / 2;
        }

        const rect = elements.viewport.getBoundingClientRect();
        const mouseX = centerX - rect.left;
        const mouseY = centerY - rect.top;

        const worldX = (mouseX - state.offset.x) / state.scale;
        const worldY = (mouseY - state.offset.y) / state.scale;

        const newScale = Math.min(Math.max(state.scale * factor, 0.1), 10);
        
        state.offset.x = mouseX - worldX * newScale;
        state.offset.y = mouseY - worldY * newScale;
        state.scale = newScale;

        applyTransform();
    }

    function resetView() {
        const vw = elements.viewport.clientWidth;
        const vh = elements.viewport.clientHeight;
        const iw = elements.img.naturalWidth || 1000;
        const ih = elements.img.naturalHeight || 800;

        state.scale = Math.min(vw / iw, vh / ih) * 0.8;
        state.offset.x = (vw - iw * state.scale) / 2;
        state.offset.y = (vh - ih * state.scale) / 2;
        applyTransform();
    }

    /**
     * DATA HANDLING
     */
    function triggerFileLoad() { elements.fileInput.click(); }

    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = JSON.parse(event.target.result);
                renderDataPoints(data);
                showToast("File Loaded Successfully");
            } catch (err) {
                alert("Invalid JSON structure.");
            }
        };
        reader.readAsText(file);
    }

    function renderDataPoints(data) {
        // Clear Existing
        document.querySelectorAll('.point').forEach(p => p.remove());
        state.points = data;
        elements.list.innerHTML = "";

        data.forEach((item, index) => {
            // 1. Create Map Marker
            const marker = document.createElement('div');
            marker.className = 'point';
            marker.id = `marker-${item.row}`;
            marker.style.left = `${item.x}px`;
            marker.style.top = `${item.y}px`;
            marker.textContent = item.row;
            
            // Marker Events
            marker.addEventListener('mouseenter', (e) => showTooltip(item, e));
            marker.addEventListener('mouseleave', hideTooltip);
            marker.addEventListener('click', () => focusPoint(item));

            elements.container.appendChild(marker);

            // 2. Create Sidebar Item
            const li = document.createElement('div');
            li.className = 'list-item';
            li.id = `list-item-${item.row}`;
            li.innerHTML = `
                <div>
                    <strong style="color:var(--accent)">#${item.row}</strong>
                    <span style="margin-left:8px">${item.plate || 'Unnamed'}</span>
                </div>
                <div class="meta">View Details</div>
            `;
            li.onclick = () => focusPoint(item);
            elements.list.appendChild(li);
        });

        document.getElementById('stats-text').textContent = `${data.length} Plates Detected`;
        applyTransform();
    }

    function focusPoint(item) {
        // Update UI Classes
        document.querySelectorAll('.point, .list-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`marker-${item.row}`).classList.add('active');
        document.getElementById(`list-item-${item.row}`).classList.add('active');
        document.getElementById(`list-item-${item.row}`).scrollIntoView({ behavior: 'smooth', block: 'nearest' });

        // Smooth Zoom to Point
        const vw = elements.viewport.clientWidth;
        const vh = elements.viewport.clientHeight;
        state.scale = 1.5; // Zoom in close
        state.offset.x = (vw / 2) - (item.x * state.scale);
        state.offset.y = (vh / 2) - (item.y * state.scale);
        
        applyTransform();
    }

    /**
     * TOOLTIP & UI
     */
    function showTooltip(item, e) {
        const signals = item.signals || {};
        let signalHtml = "";
        
        for (const [key, val] of Object.entries(signals)) {
            const color = val > -65 ? '#4ade80' : (val > -80 ? '#fbbf24' : '#f87171');
            signalHtml += `
                <div class="tt-val">
                    <div class="tt-label">${key}</div>
                    <div style="color:${color}; font-weight:bold">${val} dBm</div>
                </div>`;
        }

        elements.tooltip.innerHTML = `
            <div class="tt-header">
                <span>${item.plate || 'Unknown Plate'}</span>
                <span>#${item.row}</span>
            </div>
            <div class="tt-grid">
                ${signalHtml || '<div class="tt-val" style="grid-column: span 2">No signal data available</div>'}
            </div>
        `;
        elements.tooltip.classList.add('visible');
        moveTooltip(e);
    }

    function moveTooltip(e) {
        const x = e.clientX + 20;
        const y = e.clientY + 20;
        elements.tooltip.style.left = `${x}px`;
        elements.tooltip.style.top = `${y}px`;
    }

    function hideTooltip() { elements.tooltip.classList.remove('visible'); }

    function showToast(text) {
        const toast = document.getElementById('toast');
        toast.textContent = text;
        toast.style.display = 'block';
        setTimeout(() => toast.style.display = 'none', 3000);
    }

    window.addEventListener('mousemove', (e) => {
        if (elements.tooltip.classList.contains('visible')) moveTooltip(e);
    });
</script>

</body>
</html>